<!DOCTYPE html>
<html>
<head>
  <title>Title of the document</title>

  <script src="d3.v4.js"></script>
  <script src="node_modules/socket.io-client/dist/socket.io.js"></script>

  <style>
    body {
      background-image: url('stars.jpg')
    }
  </style>
</head>
<body>
  <script>
    // ----------------------------------------------------------------
    // Socket
    // ----------------------------------------------------------------
    var socket = io()

    socket.on('welcome', function(data) {
      console.log('hi')

      // Respond with a message including this clients' id sent from the server
      socket.emit('i am client', {data: 'foo!', id: data.id})
    })
    socket.on('time', function(data) {
      console.log('time')
    });
    socket.on('error', console.error.bind(console))
    socket.on('message', console.log.bind(console))
    socket.on('whoot', function(a, b) { console.log(a, b) })

    var synced = false

    socket.on('addTile', function (data) { addTile(data.id, data.type) })
    socket.on('removeTile', removeTile)
    socket.on('roomState', function (data) { 
      synced = true
      for (var id in data) {
        addTile(id, data[id])
      }
    })

    // ----------------------------------------------------------------
    // Tiler
    // ----------------------------------------------------------------
    var tiles = {}

    var tileDescriptions = {
      cobblestone: {
        url: 'cobblestone.png'
      }, 
      wireframe: {
        url: 'wireframe.png'
      },
      negative: {
        url: 'negative.png'
      }
    }

    function createTile (type) {
      var tile = world.append('img')
        .attr('src', tileDescriptions[type].url)
        .style('position', 'absolute')

      return tile
    }

    function tileID (grid) {
      return String(grid[0]) + ',' + String(grid[1]) + ',' + String(grid[2])
    }

    function id2grid (id) {
      return id.split(',').map(function (loc) { return Number(loc) })
    }

    // Create world
    var world = d3.select('body')
      .append('div')
      .attr('id', 'world') 
      .style('width', '2000px')
      .style('height', '2000px')

    var drawing = false
    var erasing = false

    wireframe = createTile('wireframe')
 
    world.on('mousedown', function (a, b) {
      var cursor = d3.mouse(this)
      var grid = pixel2grid(cursor)
      var id = tileID(grid)

      d3.event.preventDefault();

      if (tiles[id]) {
        drawing = false
        erasing = true
      } else {
        drawing = true
        erasing = false
      }

      // Trigger redraw
      mousemove.call(this)
    })

    world.on('mouseup', function (a, b) {
      d3.event.preventDefault();

      drawing = false
      erasing = false

      // Trigger redraw
      mousemove.call(this)
    })
 
    world.on('mousemove', mousemove) 

    function mousemove () {
      var cursor = d3.mouse(this)
      var grid = pixel2grid(cursor)
      var px = grid2pixel(grid)
      var id = tileID(grid)

      wireframe
        .style('left', px[0] + 'px')
        .style('top', px[1] + 'px')
        .style('z-index', 1000)

      if (drawing || (!erasing && !tiles[id])) {
        wireframe
          .attr('src', tileDescriptions['wireframe'].url)
      } else {
        wireframe
          .attr('src', tileDescriptions['negative'].url)
      }

      if (synced) {
        if (drawing) {
          addTile(id, 'cobblestone')
        } else if (erasing) {
          removeTile(id)
        }
      }
    }

    function addTile (id, type) {
      if (!tiles[id]) {
        var grid = id2grid(id)
        var px = grid2pixel(grid)

        var tile = createTile(type)

        tile
          .style('left', px[0] + 'px')
          .style('top', px[1] + 'px')
          .style('z-index', px[2])
          .attr('i', grid[0])
          .attr('j', grid[1])

        if (!document.hidden) {
          tile.style('top', px[1] - 500 + 'px')
          tile.transition().ease(d3.easeBounce)
            .style('top', px[1] + 'px')
        }

        tiles[id] = tile

        socket.emit('addTile', {id: id, type: type})
      }
    }

    function removeTile (id) {
      if (tiles[id]) {
        var tile = tiles[id] 
        var top = Number(tile.style('top').substr(0, tile.style('top').length - 2))

        if (!document.hidden) {
          tile.transition().ease(d3.easeLinear)
            .style('top', top + 300 + 'px')
            .style('opacity', 0)
            .remove()
        } else {
          tile.remove()
        }

        delete tiles[id]

        socket.emit('removeTile', id)
      }
    }


    /*
    var queue = []
    var queueTimer
    function queueUp (title, data) {
      console.log(title, data)

      queue.unshift({title: title, data: data})

      if (queueTimer) {
        clearTimeout(queueTimer)
        setTimeout(queuePop, 1000)
      } else {
        clearTimeout(queueTimer, 1000)
        setTimeout(queuePop)
      }

			setTimeout(queuePop, 1000)
    }

    function queuePop () {
      queuePop

      socket.emit(tlte, id)
    }
    */


    function pixel2grid (cursor, i) {
      var iso = [],
          x = cursor[0],
          y = cursor[1],
          height = 0,
          i = i || 0
 
      y += height * 32 - 25
 
      iso[0] = Math.floor(x / 128 - y / 64)
      iso[1] = Math.floor(x / 128 + y / 64)
      iso[2] = i
  
      return iso
   }
 
   function grid2pixel(iso) {
     var px = [],
         i = iso[0],
         j = iso[1],
         h = iso[2]

     // Rotate
     px[0] = i * 64  + j * 64
     px[1] = -i * 32 + j * 32
     px[2] = -i + j + h 

     px[1] -= h * 32

     return px 
   }


 </script>
</body>
</html>
